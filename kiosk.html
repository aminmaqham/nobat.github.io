<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>دریافت نوبت</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .kiosk-container { width: 90%; max-width: 800px; text-align: center; }
        .kiosk-header { font-size: 2.5em; margin-bottom: 20px; color: var(--primary-color); }
        .kiosk-subheader { font-size: 1.2em; margin-bottom: 40px; color: var(--dark-text); }
        .service-selection { display: flex; flex-direction: column; gap: 15px; }
    </style>
</head>
<body>
    <div class="kiosk-container">
        <h1 class="kiosk-header">به سیستم نوبت‌دهی خوش آمدید</h1>
        <p class="kiosk-subheader">لطفاً خدمت مورد نظر خود را انتخاب کرده و کلید مربوطه را روی کیپد فشار دهید.</p>
        <div id="service-selection" class="service-selection">
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <script>
        // --- APPWRITE SETUP ---
        const APPWRITE_ENDPOINT = 'https://cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '68a8d1b0000e80bdc1f3';
        const DATABASE_ID = '68a8d24b003cd6609e37';
        const SERVICES_COLLECTION_ID = '68a8d28b002ce97317ae';
        const TICKETS_COLLECTION_ID = '68a8d63a003a3a6afa24';

        const { Client, Databases, ID, Query, Permission, Role } = Appwrite;

        const client = new Client();
        client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
        const databases = new Databases(client);

        let services = [];
        let tickets = [];

        const serviceSelectionDiv = document.getElementById('service-selection');

        async function loadDataAndRender() {
            try {
                const [servicesResponse, ticketsResponse] = await Promise.all([
                    databases.listDocuments(DATABASE_ID, SERVICES_COLLECTION_ID, [Query.orderAsc('name')]),
                    databases.listDocuments(DATABASE_ID, TICKETS_COLLECTION_ID, [Query.limit(5000)]) // Get all tickets for counting
                ]);
                services = servicesResponse.documents;
                tickets = ticketsResponse.documents;

                serviceSelectionDiv.innerHTML = '';
                services.forEach((service, index) => {
                    const button = document.createElement('button');
                    button.className = 'service-btn';
                    button.innerHTML = `<div class="service-name">(${index + 1}) ${service.name}</div>`;
                    button.dataset.key = index + 1;
                    button.dataset.serviceId = service.$id;
                    serviceSelectionDiv.appendChild(button);
                });

            } catch (error) {
                console.error("Failed to load initial data:", error);
                serviceSelectionDiv.innerHTML = '<p>خطا در اتصال به سرور نوبت‌دهی</p>';
            }
        }

        async function generateAndPrintTicket(serviceId) {
            const service = services.find(s => s.$id === serviceId);
            if (!service) return;

            const serviceTickets = tickets.filter(t => t.service_id === serviceId && t.ticket_type === 'regular');
            const specificNumber = (serviceTickets.length) + service.start_number;
            const waitingCount = tickets.filter(t => t.service_id === service.$id && t.status === 'در حال انتظار').length;
            const estimatedWait = waitingCount * (service.estimation_mode === 'smart' ? service.smart_time : service.manual_time);

            const newTicketData = {
                service_id: serviceId,
                specific_ticket: specificNumber,
                status: 'در حال انتظار',
                ticket_type: 'regular',
                // We don't need user-specific data for kiosk
            };

            try {
                const createdTicket = await databases.createDocument(
                    DATABASE_ID, TICKETS_COLLECTION_ID, ID.unique(), newTicketData,
                    [Permission.read(Role.users()), Permission.update(Role.users()), Permission.delete(Role.users())]
                );
                
                // Send data to the main process for printing
                window.electronAPI.printTicket({
                    specific_ticket: createdTicket.specific_ticket,
                    serviceName: service.name,
                    estimatedWait: Math.round(estimatedWait)
                });
                
                // Reload data to get the latest ticket counts
                await loadDataAndRender();

            } catch (error) {
                console.error("Failed to create or print ticket:", error);
            }
        }

        // Listen for keypad presses
        document.addEventListener('keydown', (event) => {
            const key = parseInt(event.key);
            if (!isNaN(key) && key > 0 && key <= services.length) {
                const serviceId = services[key - 1].$id;
                generateAndPrintTicket(serviceId);
            }
        });

        // Initial load
        loadDataAndRender();
    </script>
</body>
</html>